{% extends '_base.html' %}
{% load staticfiles curso %}
{% block section_attrs %}id="carrinho"{% endblock %}
{% block section %}
    <div class="container">
        <div class="col-sm-12">
            <div class="center-carrinho-navegacao mg-top20">
                <div class="carrinho-navegacao">
                    <a href="#">
                        <svg version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px" height="35px" viewBox="0 0 35 35" enable-background="new 0 0 35 35" xml:space="preserve">
                        <polygon points="22.647,28.045 11.79,17.5 22.647,6.955 23.21,7.534 12.949,17.5 23.21,27.466 			"></polygon>
                    </svg>
                    </a>

                    <div>
                        <div>
                            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px" height="35px" viewBox="234.628 234.628 35 35" enable-background="new 234.628 234.628 35 35" xml:space="preserve"> <path d="M263.029,246.049l-17.508-0.003l-0.734-2.527c-0.109-0.376-0.413-0.674-0.792-0.776l-2.568-0.695 c-0.097-0.026-0.196-0.04-0.296-0.04c-0.509,0-0.958,0.344-1.092,0.836c-0.079,0.292-0.04,0.597,0.111,0.859 c0.15,0.262,0.394,0.45,0.686,0.528l1.955,0.529l3.968,14.312c-0.565,0.278-0.932,0.856-0.932,1.5c0,0.923,0.75,1.673,1.673,1.673 c0.922,0,1.673-0.75,1.673-1.673c0-0.021,0-0.044-0.001-0.065h8.078c-0.001,0.021-0.002,0.044-0.002,0.065 c0,0.923,0.751,1.673,1.674,1.673c0.922,0,1.673-0.75,1.673-1.673c0-0.848-0.645-1.559-1.47-1.66 c-2.008-0.324-10.201-0.721-10.201-0.721l-0.269-1.053h10.223c0.522,0,0.987-0.352,1.13-0.854l2.21-7.783h0.812 c0.678,0,1.227-0.549,1.227-1.227C264.256,246.598,263.707,246.049,263.029,246.049z M250.008,254.535h-1.917 c-0.052-0.001-0.129,0.011-0.165-0.112c-0.044-0.157-0.107-0.372-0.107-0.372l-1.502-5.291c-0.007-0.026-0.002-0.054,0.014-0.075 c0.017-0.021,0.042-0.034,0.069-0.034h2.329c0.041,0,0.075,0.027,0.084,0.067l1.27,5.688l0.005,0.018 c0.002,0.008,0.003,0.016,0.003,0.024C250.092,254.496,250.055,254.534,250.008,254.535z M254.898,248.755l-1.035,5.712 c-0.009,0.039-0.044,0.067-0.084,0.067h-1.446c-0.041,0-0.075-0.028-0.084-0.067l-1.035-5.712c-0.005-0.025,0-0.052,0.017-0.072 s0.041-0.032,0.067-0.032h3.516c0.026,0,0.051,0.012,0.066,0.032C254.897,248.704,254.904,248.73,254.898,248.755z M259.795,248.76 l-1.622,5.712c-0.01,0.036-0.044,0.063-0.083,0.063h-1.982c-0.026,0-0.051-0.012-0.067-0.032s-0.022-0.047-0.017-0.073l1.275-5.711 c0.009-0.039,0.044-0.067,0.084-0.067h2.329c0.026,0,0.053,0.013,0.068,0.034C259.797,248.707,259.802,248.734,259.795,248.76z"></path> </svg>
                        </div>
                        <div>
                            Carrinho
                        </div>
                    </div>
                    <a href="#">
                        <svg version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px" height="35px" viewBox="0 0 35 35" enable-background="new 0 0 35 35" xml:space="preserve"> <polygon points="11.79,27.466 22.051,17.5 11.79,7.534 12.353,6.955 23.21,17.5 12.353,28.045"></polygon> </svg>
                    </a>
                </div>
                <div class="clear"></div>
            </div>
            <!---------navegacao------carrinho---------->
        </div>
        <div class="col-sm-12">
            <div class="cabecalho-cursos">
                <h1>Meu carrinho</h1>

                <div class="linha-breadcrumb">
                    <ul class="breadcrumb">
                        <li>
                            <a href="{% url 'website:index' %}">Home</a>
                        </li>
                        <li>
                            <a href="#">Cursos</a>
                        </li>
                        <li class="active">Carrinho</li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="col-sm-12">
            {% for item in cart.items %}
                <div class="carrinho-linha">
                    <div class="row">
                        <div class="col-sm-2">
                            <div class="img-carrinho">
                                <img src="{{ STATIC_URL }}assets/fotos/produto01.png">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="texto-carrinho">
                                {{ item.product }}
                            </div>
                            <strong class="bold text-danger">
                                {% if item.product.aluno %}
                                    Pacote montado por você
                                {% else %}
                                    {{ item.product.categoria.nome }}
                                {% endif %}
                            </strong>
                        </div>
                        {% comment %}
                        <div class="col-sm-2">
                            <form class="quantidade">
                                <label>
                                    <span class="total bold" style="font-size: 18px">{{ item.product.valor }}</span>
                                    <span style="color: darkred">&nbsp;&nbsp;x&nbsp;</span>
                                    <input onchange="Dajaxice.apps.curso.set_qtda(Dajax.process, {'curso_id': {{ item.product.id }}, 'qtda': $(this).val()});block();"
                                           type="number" placeholder="0" value="{{ item.quantity }}">
                                </label>
                            </form>
                        </div>
                        {% endcomment %}
                        <div class="col-sm-4">

                            <div class="metade-precos bdr-right">
                                <div class="titulo04">Subtotal</div>
                                <div class="total bold">{{ item.subtotal }}</div>
                            </div>
                        </div>
                        <div class="clear"></div>
                        <div class="col-sm-12">
                            <div class="line-px"></div>
                        </div>
                        <div class="clear"></div>
                        <a class="lixo" href="#"
                           f>
                            <div class="icon-lixo" style="background-color: #E45149">
                                <svg version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="20px" height="20px" viewBox="0 0 35 35" enable-background="new 0 0 35 35" xml:space="preserve"> <path fill="#FFFFFF" d="M26.654,9.017H9.841C9.378,9.017,9,9.395,9,9.858v1.681c0,0.463,0.378,0.842,0.841,0.842h0.184 l1.938,11.576c0.34,1.648,1.467,2.713,2.872,2.713h6.83c1.441,0,2.571-1.074,2.877-2.744l1.932-11.545h0.183 c0.461,0,0.84-0.379,0.84-0.842V9.858C27.494,9.395,27.115,9.017,26.654,9.017z M22.536,12.762l-0.382-0.381h0.764L22.536,12.762z M17.005,24.988l-0.477-0.477l1.683-1.682l1.681,1.682l-0.476,0.477H17.005z M13.502,12.381h0.764l-0.381,0.381L13.502,12.381z M21.941,13.355l-1.455,1.455l-1.684-1.682l0.751-0.75h1.412L21.941,13.355z M15.455,12.381h1.412l0.749,0.748l-1.682,1.682 l-1.455-1.453L15.455,12.381z M18.211,12.535l-0.156-0.154h0.31L18.211,12.535z M18.211,13.723l1.683,1.682l-1.683,1.682 l-1.683-1.682L18.211,13.723z M17.617,17.682l-1.682,1.682l-1.683-1.682L15.934,16L17.617,17.682z M18.211,18.275l1.683,1.684 l-1.683,1.682l-1.683-1.682L18.211,18.275z M18.806,17.682L20.488,16l1.682,1.682l-1.682,1.682L18.806,17.682z M15.34,15.404 l-1.683,1.684l-1.373-1.373l-0.023-0.141l1.624-1.623L15.34,15.404z M12.522,17.141l0.541,0.541l-0.385,0.385L12.522,17.141z M13.199,21.184l-0.351-2.098l0.809-0.811l1.684,1.684l-1.684,1.682L13.199,21.184z M15.934,20.553l1.683,1.684l-1.682,1.682 l-1.683-1.684L15.934,20.553z M18.806,22.236l1.683-1.682l1.682,1.682l-1.684,1.682L18.806,22.236z M21.081,19.959l1.683-1.682 l0.872,0.873l-0.325,1.943l-0.547,0.547L21.081,19.959z M23.358,17.682l0.629-0.629l-0.181,1.078L23.358,17.682z M22.764,17.088 l-1.683-1.684l1.456-1.453l1.683,1.682L22.764,17.088z M12.313,12.381l0.977,0.977l-1.2,1.199l-0.364-2.176H12.313z M13.61,23.646 l-0.11-0.66l0.157-0.158l1.684,1.684l-0.477,0.477h-0.031C13.957,24.988,13.671,23.938,13.61,23.646z M22.887,23.633 c-0.042,0.227-0.296,1.355-1.226,1.355H21.56l-0.479-0.477l1.684-1.684l0.22,0.221L22.887,23.633z M24.395,14.621l-1.264-1.266 l0.977-0.975h0.661L24.395,14.621z"></path> </svg>
                            </div>
                            <div class="clear"></div>
                            <span>EXCLUIR</span>
                        </a>
                    </div>
                </div>
            {% endfor %}
            <div>
                <div class="row">
                    <div class="col-sm-9">
                    </div>
                    <div class="col-sm-3">
                        <div class="table-responsive mg-top20">
                            <table class="table">
                                <tr>
                                    <td class="titulo04">
                                        <span class="pull-right">Valor Total:</span>
                                    </td>
                                    <td class="total bold">
                                        <span class="pull-right">{{ cart.total|moeda }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="titulo04">
                                        <span class="pull-right">Desconto:</span>
                                    </td>
                                    <td class="total bold">
                                        <span class="pull-right">{{ cart.discount|moeda }}</span>
                                    </td>
                                </tr>
                                <tr class="bg-success">
                                    <td class="titulo04">
                                        <span class="pull-right">Subtotal:</span>
                                    </td>
                                    <td class="total bold">
                                        <span class="pull-right">{{ cart.total_payment|moeda }}</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                {% if user.is_authenticated and user.aluno %}
                <div class="row">
                    <div class="col-sm-9">
                    </div>
                    <div class="col-sm-3">
                        <form class="form-horizontal" role="form">
                            <fieldset>
                                <div class="control-group">
                                    <div class="input-group">
                                        <input type="text" class="form-control input-lg" id="cupom-desconto"
                                               placeholder="Cupom" {% if cart.cupom %}value="{{ cart.cupom }}"
                                               disabled{% endif %}>
                                        <div class="input-group-addon">
                                            {% if cart.cupom %}
                                                <button id="btn-cupom-remover" type="button"
                                                        class="btn btn-sm btn-danger">Remover
                                                </button>
                                            {% else %}
                                                <button id="btn-cupom" type="button" class="btn btn-sm btn-success">
                                                    Validar
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                {% endif %}
                <div class="row">
                    <div class="col-sm-8">
                    </div>
                    <div class="col-sm-4">
                        <div class="preco">
                            <span class="titulo04" style="font-size: medium">Esta compra está sendo feita no <strong>Brasil </strong></span>
                            <span class="total bold"><img src="{% static 'images/logos/flag_br.png' %}"/></span>
                        </div>
                    </div>
                </div>
            </div>
            <!--carrinho-linha--->
        </div>
        <div class="container">
            <div class="col-sm-12">
                <div class="center-carrinho-navegacao mg-top20">
                    <div class="col-sm-6">
                        <div class="carrinho-navegacao pull-left">
                            <a href="{% url 'website:index' %}" class="btn-continuar">
                                <div>
                                    <svg version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg"
                                         xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px"
                                         height="35px" viewBox="0 0 35 35" enable-background="new 0 0 35 35"
                                         xml:space="preserve">
                                        <polygon points="22.647,28.045 11.79,17.5 22.647,6.955 23.21,7.534 12.949,17.5 23.21,27.466"></polygon>
                                    </svg>
                                </div>
                                <div class="">Continuar Comprando&nbsp;</div>
                            </a>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="carrinho-navegacao pull-right">
                        {% if user.is_authenticated and user.aluno %}
                            <input id="pagseguroButton"
                                   type="image"
                                   src="{% static 'pagseguro/botao-209x48-pagar.gif' %}"
                                   alt="Pague com PagSeguro - é rápido, grátis e seguro!"
                                   data-toggle="modal"
                                   data-target="#cpfModal"/>
                        {% else %}
                            <button onclick="login()" class="btn btn-warning navbar-btn"><i class="fa fa-user fa-fw"></i> Cadestre-se ou efetue login para efetuar o pagamento</button>
                        {% endif %}
                        </div>
                    </div>
                    <div class="clear"></div>
                </div>
                <!---------navegacao------carrinho---------->
            </div>
        </div>
    </div>
    <br><br>
    <!-- Modal -->
    <!-- Modal -->
<div class="modal fade" id="cpfModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Informe seu CPF!</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 mg-bot10">
                        <span>
                            <i class="fa fa-question-circle text-info"></i>
                            <span tabindex="0" class="text-info"
                               role="button"
                               container="body"
                               data-placement="left"
                               data-toggle="popover"
                               data-trigger="focus"
                               title="JusTutor"
                               data-content="O CPF é necessário para o JusTutor emitir a documentação fiscal."> Porque devo informar meu CPF?</span>
                        </span>
                    </div>
                    <div class="col-sm-12">
                      <div class="form-group">
                          <input type="text" class="form-control" id="idCPF" placeholder="Somente números">
                      </div>
                    </div>
                    <div class="col-sm-12">
                        <span id="helpBlock" class="text-danger hide"><i class="fa fa-remove"></i> CPF Inválido.</span>
                        <span id="helpBlockInforme" class="text-danger hide"><i class="fa fa-remove"></i> Informe o CPF.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnContinuar">continuar</button>
            </div>
            <a target="_self" href="" id="checkout" class="hide"></a>
        </div>
    </div>
    <form id="checkoutFrm" method="get" action="{% url 'website:pagseguro_checkout' %}">
        {% csrf_token %}
        <input id='chkpk' type="hidden" name="pk" value=""/>
        <input id='chkplt' type="hidden" platform="platform" value=""/>
    </form>
</div>
{% endblock %}
{% block busca %} {% endblock %}
{% block extra_js %}
    <script type="text/javascript" src="https://stc{% if sandbox %}.sandbox{% endif %}.pagseguro.uol.com.br/pagseguro/api/v2/checkout/pagseguro.lightbox.js"></script>
    <script src="assets/js/util.js"></script> <!-- util functions included in the CodyHouse framework -->
    <script src="assets/js/main.js"></script>
    <script>
        window.addEventListener("message", receiveMessage, false);
        function receiveMessage(event) {
            console.log('ebkjhkshdksdfkjhsdfkjh', event.origin);
          if (event.origin !== "https://pagseguro.uol.com.br")
            return;

          // ...
        }
        // using jQuery
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        function checkout(code, pk) {
            var callback = {
                success: function (transactionCode) {
                    console.log("success", transactionCode);
                    //Insira os comandos para quando o usuário finalizar o pagamento.
                    //O código da transação estará na variável "transactionCode"
                    $.post("{% url 'website:pagseguro_settransaction' %}", {
                        'pk': pk,
                        'trans': transactionCode,
                        'csrfmiddlewaretoken': csrftoken
                    });
                    console.log("endost");
                    document.location.href = '/pagseg/transacao/' + transactionCode;
                    console.log("Compra feita com sucesso, código de transação: " + transactionCode);
                },
                abort: function () {
                    //Insira os comandos para quando o usuário abandonar a tela de pagamento.
                    $.unblockUI();
                    Swal.fire({
                        title: 'Pagamento não finalizado!',
                        html: "Você cancelou o processo do pagamento no meio da transação.",
                        type: 'error',
                        showCancelButton: false,
                    });
                    console.log("abortado");
                },
                fail: function () {
                    alert('erro')
                }
            };
            //Chamada do lightbox passando o código de checkout e os comandos para o callback
            var isOpenLightbox = PagSeguroLightbox(code, callback);
            // Redireciona o comprador, caso o navegador não tenha suporte ao Lightbox
            if (!isOpenLightbox) {
                console.log("Redirecionamento");
                window.location.replace('https://pagseguro.uol.com.br/v2/checkout/payment.html?code=' + code);
            }
        }
        function pagar() {
            var pk = 'VD{% now 'dmY.Hi' %}-{{ request.user.aluno.pk }}';
            let platform = window.navigator.platform;
            alert(platform);
            if (platform == "iPhone") {
                alert('>>> enviar');
                $('#chkpk').val(pk);
                $('#chkplt').val(platform);
                $('#checkoutFrm').submit();
            } else {
                block();
                $.post("{% url 'website:pagseguro_checkout' %}", {
                    'pk': pk, 'csrfmiddlewaretoken': csrftoken, 'platform': window.navigator.platform
                })
                    .done(function (data) {
                        if (data.erro == false) {
                            $.unblockUI();
                            var code = data.code;
                            checkout(code, pk)
                        } else {
                            $.unblockUI();
                            for (var key in data.errors) {
                                console.log(data.errors[key]);
                                toastr.error(data.errors[key], 'Erro', {timeOut: 20000});
                            }
                        }
                    })
                    .fail(function () {
                        $.unblockUI();
                        alert('erro')
                    });
            }
        }
        // REMOVER ITEM
        function removeProd(curso_id, nome_curso) {
            Swal.fire({
                title: "Deseja remover o item?",
                html: '<b style="font-size: 24px; color: #4A91D3">' + nome_curso + '</b>',
                type: "warning",
                showCancelButton: true,
                cancelButtonText: 'Não, deixe como está.',
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Sim, remova o item!",
                closeOnConfirm: false,
            }).then(function (result) {
                if (result.value) {
                    Dajaxice.apps.curso.remove_item(Dajax.process, {'curso_id': curso_id});
                }
            });
        }
        // REMOVER CUPOM
        $('#btn-cupom-remover').on('click', function (e) {
            block();
            var $cupom = $('#cupom-desconto');
            Dajaxice.apps.cupom.remover_cupom(Dajax.process, {codigo: $cupom.val()});
        });
        // ADICIONAR CUPOM
        $('#btn-cupom').on('click', function (e) {
            e.preventDefault();
            var $cupom = $('#cupom-desconto');
            if (!$cupom.val()) {
                swal_alert('JusTutor', 'Para validar seu cupom, digite o código.', 'error');
                $cupom.focus();
                return false;
            } else {
                if ($cupom.val() == $cupom.data('atu')) {
                    alert('Esse cupom já foi validado');
                    return false;
                } else {
                    block('Aguarde...');
                    Dajaxice.apps.cupom.desconto_cupom(Dajax.process, {codigo: $cupom.val()});
                }
            }
        });
        // MODAL
        $('#cpfModal').on('hide.bs.modal', function (event) {
            $('#idCPF').val('');
            $('#helpBlock').addClass('hide');
            $('#helpBlockInforme').addClass('hide')
        });
        $('#cpfModal').on('shown.bs.modal', function (event) {
            {% if request.user.aluno.cpf %}
                $('#idCPF').val('{{ request.user.aluno.cpf }}');
                $('#idCPF').select();
            {% endif %}
            $('#idCPF').focus();
        });
        $('#btnContinuar').on('click', function (e) {
            var cpf = $('#idCPF').val();
            if (!cpf) {
                $('#helpBlock').addClass('hide');
                $('#helpBlockInforme').removeClass('hide');
                $('#helpBlockInforme').pulsate({color: "#DE7A43", repeat: false});
                $('#idCPF').focus();
            } else {
                block();
                $('#helpBlockInforme').addClass('hide');
                Dajaxice.apps.curso.validar_cpf(Dajax.process, {'cpf': cpf});
            }

        });
    </script>

{% endblock %}
