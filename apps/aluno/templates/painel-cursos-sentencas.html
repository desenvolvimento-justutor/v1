{% extends '_base-painel-aluno.html' %}
{% load  thumbnail aluno_tags curso static %}
{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'assets/css/select2.css' %}" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="{% static 'website/direct_call_html_plugin/css/animate.min.css' %}"/>

    <!-- Click To Call Layout CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'website/direct_call_html_plugin/css/call-layout.css' %}"/>
    <!-- Click To Call Custom Style-1 CSS  (required) -->
    <link rel="stylesheet" type="text/css"
          href="{% static 'website/direct_call_html_plugin/css/style/call-style7.css' %}"/>
    <!-- Click To Call Color CSS (This is only for Live Demo) -->
    <link id="call-color" rel="stylesheet"
          href="{% static 'website/direct_call_html_plugin/css/colors/color-green.css' %}">
{% endblock %}
{% block panel_content %}
    <style>
        #modalSentencaAluno, #modalCorrecao{
            z-index: 1050 !important
        }
    </style>
    <div class="row">
        <div class="col-lg-12">
            <div class="main-box">
                <header class="main-box-header clearfix">
                    <h2>Filtro <small class="text-info">{{ itens.count }} Atividade{{ itens.count|pluralize }}</small></h2>
                </header>
                <div class="main-box-body clearfix">
                    <form class="form-inline" role="form" method="get">
                        <div class="form-group">
                            <select class="form-control" name="categoria">
                                <option value="" {% if not data.categoria %}selected{% endif %}>Selecione o tipo
                                </option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria.pk }}"
                                            {% ifequal data.categoria categoria.pk|slugify %}selected{% endifequal %}>{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group checkbox checkbox-nice">
                            <input type="checkbox" id="expirado" name="expirado"
                                   {% ifequal data.expirado 'on' %}checked="checked"{% endifequal %}>
                            <label for="expirado">
                                Exibir atividades expiradas
                            </label>
                        </div>
                        <button style="margin-left: 10px;" type="submit" class="btn btn-success">Filtar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% if itens %}
        <div class="main-box-body clearfix">
            <div class="tabs-wrapper">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#tab-atividades" data-toggle="tab">Atividades</a></li>
                    <li class=""><a href="#tab-mensagens" data-toggle="tab">Mensagens</a></li>
                </ul>
                <div class="tab-content">
                    <!-- TAB ATIVIDADES -->
                    <div class="tab-pane fade active in" id="tab-atividades">
                        <div class="col-lg-12">
                            <div class="main-box clearfix" style="height: 100%">
                                <div class="main-box-body clearfix">
                                    <div class="table clearfix">
                                        <table class="table user-list table-hover">
                                            <thead>
                                            <tr>
                                                <th><span>Curso</span></th>
                                                <th><span>Nível</span></th>
                                                <th><span>Data</span>/<span>Prazo</span></th>
                                                <th><span>Professor</span></th>
                                                <th class="text-center"><span>Status</span></th>
                                                <th>&nbsp;</th>
                                                <th>&nbsp;</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in itens %}
                                                {% with item.curso as curso %}
                                                    {% with curso.sentenca_avulsa as sentenca %}
                                                    {% sentenca_data_limite item.checkout.transaction.last_event_date as data_limite %}
                                                    {% sentenca_data_limite item.checkout.transaction.last_event_date True as expirado %}
                                                    {% get_sentenca sentenca aluno as st %}
                                                    {% get_tabela_correcao_aluno_st sentenca aluno as tabela_correcao_aluno %}

                                                    <tr>
                                                        <td width="30%">
                                                            <a href="javascript:void(0)" class="table-link success" data-container="body" placement="top"
                                                                              data-toggle="popover" title="Código da compra"
                                                                              data-content="{{ item.checkout }}">
                                                                <i class="fa fa-shopping-cart"></i>
                                                            </a>
                                                            {{ curso }}
                                                        </td>
                                                        <td width="10%">{{ sentenca.span_nivel|safe }}</td>
                                                        <td width="10%">
                                                            <strong class="text-success">{{ item.checkout.transaction.last_event_date|date:"SHORT_DATE_FORMAT" }}</strong>
                                                            <strong class="text-danger">{{ data_limite|date:"SHORT_DATE_FORMAT" }}</strong>
                                                        </td>
                                                        <td width="20%">
                                                            {% thumbnail sentenca.professor.foto "50x50" crop="center" as im %}
                                                                <img src="{{ im.url }}" alt="{{ aluno }}">
                                                            {% empty %}
                                                                <img src="{{ STATIC_URL }}images/logos/icone24-borda.svg" alt="{{ aluno }}"/>
                                                            {% endthumbnail %}
                                                            <a href="javascript:void(0)" class="user-link">{{ sentenca.professor }}</a>
                                                            <span class="user-subhead">{{ sentenca.professor.graduacao }}</span>
                                                        </td>
                                                        <td width="10%">
                                                            {% if item.checkout.transaction %}
                                                                {% with  item.checkout.transaction.status as status %}
                                                                    {% if status in 'pago,disponivel' %}
                                                                        {% if st %}
                                                                            {% if st.correcao %}
                                                                                <a target="_blank" href="{{ st.correcao.url }}" class="table-link success"  data-toggle="tooltip" data-original-title="Baixar Correção"><i class="fa fa-download"></i> Correção</a>
                                                                            {% elif st.correcao_individual %}
                                                                                <a target="_blank" href="/curso/atividade/imprimir/{{ st.pk }}/?action=resposta_sentenca&notprint=sim" class="table-link success"  data-toggle="tooltip" data-original-title="Visualizar Correção"><i class="fa fa-print"></i> Correção</a>
                                                                            {% else %}
                                                                                {{ st.span_status|safe }}
                                                                            {% endif %}
                                                                            {% if st.status in 'A,C' or expirado and sentenca.gabarito %}
                                                                                {% if sentenca.gabarito %}
                                                                                <a target="_blank" href="{{ sentenca.gabarito.url }}" class="table-link success"
                                                                                   data-toggle="tooltip" data-original-title="Baixar Gabarito" style="display: block; margin-top: 4px">
                                                                                    <i class="fa fa-pencil-square-o"></i> Gabarito
                                                                                </a>
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <form method="post">
                                                                                {% csrf_token %}
                                                                                <input type="hidden" name="sentenca_id" value="{{ sentenca.id }}">
                                                                                <button data-toggle="tooltip" data-original-title="Clique aqui para começar a redigir a sua sentença." type="submit" class="btn btn-success btn-sm"><i class="fa fa-play"></i> Iniciar</button>
                                                                            </form>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <a class="btn btn-success btn-sm" disabled=""><i class="fa fa-play"></i> Iniciar</a>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% else %}
                                                                <a class="btn btn-success btn-sm" disabled=""><i class="fa fa-play"></i> Iniciar</a>
                                                            {% endif %}
                                                        </td>
                                                        <td width="5%" style="max-width: 70px">
                                                            {% if item.checkout.transaction %}
                                                                {% with  item.checkout.transaction.status as status %}
                                                                    {% if status in 'pago,disponivel' %}
                                                                        <div style="width: 80px;" class="btn-group" data-toggle="tooltip" data-original-title="Menu">
                                                                            <button data-toggle="dropdown" class="btn btn-success btn-xs dropdown-toggle has-tooltip" type="button">
                                                                            Menu <span class="caret"></span>
                                                                            </button>
                                                                            <ul class="dropdown-menu">
                                                                                {% if sentenca.formulario and st.status in 'C,A' %}
                                                                                    <li>
                                                                                        <a href="javascript:" data-pk="{{ sentenca.pk }}" data-toggle="modal" data-target="#chartModal"
                                                                                           title="Ranking das notas">
                                                                                            <i class="fa fa-bar-chart text-warning"></i> Ranking das notas
                                                                                        </a>
                                                                                    </li>
                                                                                {% endif %}
                                                                                <li>
                                                                                    <a href="#" data-toggle="modal" data-target="#modalTarefa" data-titulo="{{ sentenca }}" data-pk="{{ sentenca.curso.pk }}" data-stpk="{% if st %}{{ st.pk }}{% else %}0{% endif %}">
                                                                                        <i class="fa fa-eye" data-toggle="tooltip" data-original-title="Visualizar Sentença"></i> Visualizar Atividade
                                                                                    </a>
                                                                                </li>
                                                                                <li>
                                                                                    <a target="_blank" href="{% url 'curso:sentenca-imprimir' sentenca.curso.pk %}" data-toggle="tooltip" data-original-title="Imprimir Sentença">
                                                                                        <i class="fa fa-print"></i> Imprimir Atividade
                                                                                    </a>
                                                                                </li>
                                                                                {% if st %}
                                                                                    <li>
                                                                                        <a href="{% url 'curso:sentenca-responder' st.pk %}" data-toggle="tooltip" data-original-title="Responder">
                                                                                            <i class="fa fa-pencil"></i> Responder
                                                                                        </a>
                                                                                    </li>
                                                                                {% endif %}
                                                                                {% with sentenca.sentencamodelo_set.all as modelos %}
                                                                                    {% if modelos %}
                                                                                        <li class="divider"></li>
                                                                                        <li class="dropdown-header"><i class="fa fa-plus"></i> Atividades</li>
                                                                                        {% for modelo in modelos %}
                                                                                            {% if st.status in 'C,A' or expirado %}
                                                                                                <li><a target="_blank" href="{{ modelo.arquivo.url }}">Atividade {{ modelo.pk|stringformat:"03d" }}</a></li>
                                                                                            {% else %}
                                                                                                <li class="disabled"><a href="javascript:void(0)">Atividade {{ modelo.pk|stringformat:"03d" }}</a></li>
                                                                                            {% endif %}
                                                                                        {% endfor %}
                                                                                    {% endif %}
                                                                                {% endwith %}

                                                                            </ul>
                                                                        </div>

                                                                    {% elif status in 'aguardando,em_analise' %}
                                                                        <span class="label label-warning">{{ item.checkout.transaction.get_status_display }}</span>
                                                                    {% else %}
                                                                        <span class="label label-danger">{{ item.checkout.transaction.get_status_display }}</span>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% else %}
                                                                <span class="label label-warning">Aguardando transação do PagSeguro</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center" width="10%">
                                                            {% if tabela_correcao_aluno %}
                                                                {% if tabela_correcao_aluno.pode_recorrer %}
                                                                        <button data-pk="{{ tabela_correcao_aluno.pk }}"
                                                                           data-toggle="modal" data-target="#modalRecorrer" class="btn btn-sm btn-primary"
                                                                           title="Recorrer da Nota">
                                                                            <i class="fa fa-gavel"></i>
                                                                        </button>
                                                                        <span class="badge badge-{{ tabela_correcao_aluno.status_color }}"
                                                                              data-toggle="tooltip" data-original-title="{{ tabela_correcao_aluno.get_status_display }}">&nbsp;</span>
                                                                {% else %}
                                                                    {% if tabela_correcao_aluno.status == 'corrigido' %}
                                                                         <button disabled title="Recorrer da Nota" class="btn btn-sm btn-primary">
                                                                            <i class="fa fa-gavel"></i>
                                                                        </button>
                                                                        <span class="badge badge-default" style="cursor: pointer"
                                                                              data-toggle="tooltip" data-original-title="Não disponível">&nbsp;</span>
                                                                    {% else %}
                                                                        <button data-pk="{{ tabela_correcao_aluno.pk }}"
                                                                           data-toggle="modal" data-target="#modalRecorrer" class="btn btn-sm btn-primary"
                                                                           title="Recorrer da Nota">
                                                                            <i class="fa fa-gavel"></i>
                                                                        </button>
                                                                        <span class="badge badge-{{ tabela_correcao_aluno.status_color }}" style="cursor: pointer"
                                                                              data-toggle="tooltip" data-original-title="{{ tabela_correcao_aluno.get_status_display }}">&nbsp;</span>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% else %}
                                                                <button disabled title="Recorrer da Nota" class="btn btn-sm btn-primary">
                                                                    <i class="fa fa-gavel"></i>
                                                                </button>
                                                                <span class="badge badge-default" style="cursor: pointer"
                                                                      data-toggle="tooltip" data-original-title="Não disponível">&nbsp;</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% if expirado %}
                                                        <tr>
                                                            <td colspan="6" style="border-top: unset; padding-top: 0px" class="text-center">
                                                                {% if st %}
                                                                    {% if st.status == 'I' %}
                                                                        <span class="label label-danger">
                                                                            <small>O prazo de 01 (um) ano para resolver esta Atividade Avulsa já expirou. Você ainda pode acessar o gabarito da atividade</small>
                                                                        </span>
                                                                    {% endif %}
                                                                {% else %}
                                                                        <span class="label label-danger">
                                                                            <small>O prazo de 01 (um) ano para resolver esta Atividade Avulsa já expirou. Você ainda pode acessar o gabarito da atividade</small>
                                                                        </span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    {% endwith %}
                                                {% endwith %}
                                                {% endfor %}


                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- TAB VIDEOS -->
                    <div class="tab-pane fade" id="tab-mensagens">
                        {% include '_msg-professor.html' with professores=professores msg_tipo='st' %}
                    </div>

                </div>
            </div>
        </div>
        {% else %}
            <div class="col-sm-12">
                <div class="alert alert-danger">
                    <i class="fa fa-times-circle fa-fw fa-lg"></i>
                    <strong>Ops!</strong> Você não possui nenhuma Atividade Avulsa.
                </div>
            </div>
        {% endif %}
        <!-- MODAL -->
        <div class="modal fade" tabindex="-1" role="dialog" id="modalTarefa">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" style="font-weight: bold">Modal title</h4>
                    </div>
                    <div class="modal-body">
                        <div id="modalBody"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger pull-left" data-dismiss="modal"><i class="fa fa-close"></i> Fechar</button>
                        <a href="" target="_blank" id="btn-imprimir" class="btn btn-primary"><i class="fa fa-print"></i> Imprimir</a>
                        <a href="" id="btn-tarefa" class="btn btn-success"><i class="fa fa-edit"></i> Responder</a>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </div>
    <!-- MODAL -->
    <!-- MODAL -->
    <div class="modal fade" tabindex="-1" role="dialog" id="modalCorrecao">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Justutor</h4>
                </div>
                <div class="modal-body">
                    <div id="modalCorrecaoBody">
                        <div id="modalCorrecaoHtml"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal"><i class="fa fa-close"></i> Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /.modal -->
    <!-- MODAL - SENTENÇA ALUNO -->
    <div class="modal fade" tabindex="-1" role="dialog" id="modalSentencaAluno">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" style="font-weight: bold">Modal title</h4>
                </div>
                <div class="modal-body">
                    <div id="modalBody"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger pull-left" data-dismiss="modal"><i class="fa fa-close"></i> Fechar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    </div>
    <!-- MODAL -->
    <div class="modal fade" tabindex="-1" role="dialog" id="chartModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Justutor</h4>
                </div>
                <div class="modal-body">
                    <div id="modalBody">
                        <div id="modalHtml"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal"><i class="fa fa-close"></i> Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /.modal -->
    <!-- MODAL RECORRER -->
    <div class="modal fade" tabindex="-1" role="dialog" id="modalRecorrer">
        <div class="modal-dialog modal-lg" style="width: 90%">
            <div class="modal-content">
                <div class="modal-header">
                    <!--button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button-->
                    <h4 class="modal-title" id="modalRecorrerTitulo">Justutor</h4>
                </div>
                <div class="modal-body">
                    <div id="modalRecorrerBody">
                        <div id="modalRecorrerHtml"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="confirmar_recorrer()"><i class="fa fa-save"></i> Finalizar e enviar recurso</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /.modal -->
    <div class="cc-style7">
        <!-- Chat Panel -->
        <div class="cc-panel">
            <!-- Panel Header Content -->
            <div class="cc-header">
                <!-- Profile Picture -->
                <div class="cc-img-cont">
                    <img class="cc-user-img" src="" alt=""/>
                </div>
                <!-- Display Name & Last Seen -->
                <div class="cc-user-info">
                    <strong></strong>
                </div>
                <a class="cc-button closer" id="cc-close">
                    <i class="fa fa-close red" aria-hidden="true" style="display: inline-block;"></i>
                </a>
            </div>
            <!-- Panel Body Content -->
            <div class="cc-body">
                <div class="cc-content">
                    <textarea placeholder="Digite sua mensagem..." id="text-message" autofocus></textarea>
                    <input type="hidden" value="" id="pid">
                </div>
            </div>
            <!-- Panel Footer Content -->
            <div class="cc-footer">
                <!-- Start Single Contact List -->
                <a class="cc-list" id="btnEnviar">
                    <i class="fa fa-paper-plane-o" aria-hidden="true"></i>
                    <p>Enviar</p>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>
<script src="{% static 'assets/js/select2.full.js' %}"></script>

<script>
    function verTarefa(atividadeID) {
        $('#modalTarefa').modal('show');

    }
    // MODAL CORRECAO
    $('#modalCorrecao').on('show.bs.modal', function (event) {
        var pk = $(event.relatedTarget).data('pk');
        var posting = $.post('{% url 'professor:formulario-estatistica-correcao' %}', {pk: pk} );
        {#$.blockUI({ message: 'aguarde' });#}
        posting.done(function( data ) {
            //$.unblockUI();
            if (data.message) {
                toastr.error(data.message, 'Erro');
            };
            if (!data.html) {
                toastr.error('Não há dados para gerar a estatística.', 'Erro');
                $('#modalHtml').html(
                    '<div class="alert alert-danger">\n' +
                    '<i class="fa fa-times-circle fa-fw fa-lg"></i>\n' +
                    '<strong>Opss!</strong> ' + data.message +
                    '</div>'
                );
            } else {
                $('#modalCorrecaoHtml').html(data.html);
                $('#modalCorrecaoBody').slimScroll({
                    start: 'top',
                    height: '400px'
                });
            }
        });
        console.log('**', pk)
    });
    // MODAL TAREFA
    $('#modalTarefa').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var titulo = button.data('titulo');
        var pk = button.data('pk');
        var stpk = button.data('stpk');
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this);
        modal.find('.modal-title').text(titulo);

        if (stpk == 0){
            $('#btn-tarefa').attr('disabled', 'true');
        } else {
            $('#btn-tarefa').removeAttr("disabled");
            $('#btn-tarefa').prop('href', '/curso/sentenca/responder/' + stpk);
        }
        $('#btn-imprimir').prop('href', '/curso/sentenca/imprimir/' + pk);
        $.getJSON( "{% url 'curso:get-amostra-json' %}?pk=" + pk, function( json ) {
            modal.find('#modalBody').html($.parseHTML( json.conteudo ));
            $('#modalBody').slimScroll({
                start: 'top',
                height: '400px'
            });
        });
    });
    // MODAL SENTENCA ALUNO
    $('#modalSentencaAluno').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var titulo = button.data('titulo');
        var pk = button.data('pk');

        var modal = $(this);
        modal.find('.modal-title').text(titulo);

        $.getJSON( "{% url 'curso:get-amostra-json' %}?tipo=resposta&pk=" + pk, function( json ) {
            modal.find('#modalBody').html($.parseHTML( json.conteudo ));
            $('#modalBody').slimScroll({
                start: 'top',
                height: '400px'
            });
        });
    });
    // MODAL RECORRER
    $('#modalRecorrer').on('hide.bs.modal', function (event) {
        $('#modalRecorrerHtml').html('');
        $('#modalRecorrerTitulo').html('Justutor')
    });
    $('#modalRecorrer').on('show.bs.modal', function (event) {
        var pk = $(event.relatedTarget).data('pk');
        var posting = $.post('{% url 'professor:formulario-recorrer' %}', {pk: pk, tipo: 'st'} );

        {#$.blockUI({ message: 'aguarde' });#}
        posting.done(function( data ) {
            //$.unblockUI();
            if (data.message) {
                toastr.error(data.message, 'Erro');
            };
            if (!data.html) {
                toastr.error('Não há dados para gerar a estatística.', 'Erro');
                $('#modalRecorrerHtml').html(
                    '<div class="alert alert-danger">\n' +
                    '<i class="fa fa-times-circle fa-fw fa-lg"></i>\n' +
                    '<strong>Opss!</strong> Não há dados para gerar a estatística.' +
                    '</div>'
                );
            } else {
                $('#modalRecorrerHtml').html(data.html);
                $("#formulario_pk").val(pk);
                $('#modalRecorrerTitulo').html('<strong>Recurso da nota</strong> - Atividade: [ ' + data.atividade_nome + ' ]');
                $('#modalRecorrerBody').slimScroll({
                    start: 'top',
                    height: '400px'
                });
            }
        });
        console.log('**', pk)
    });
    function confirmar_recorrer() {
        status = $('#formulario_status').val();
        if (status == 'corrigido') {
            Swal.fire({
                title: 'Deseja finalizar?',
                html: "Confira se todos os itens em relação aos quais você deseja recorrer estão marcados " +
                    "como recorridos. Depois de clicar em \"Finalizar\", seu recurso será enviado e não será " +
                    "mais possível alterá-lo ou refazê-lo.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, desejo finalizar!',
                cancelButtonText: 'Cancelar'
            }).then(function (result) {
                if (result.value) {
                   enviar_confirmacao()
                }
            })
        } else {
            Swal.fire('JusTutor', 'O status atual não permite mais alterações.', 'error');
        }
    }
    function enviar_confirmacao() {
        // Send the data using post
        var send = {
            action: 'confirmar',
            pk: $("#formulario_pk").val()
        };
        var posting = $.post('{% url 'professor:post-confirmar-recorrer' %}', send );
        posting.done(function( data ) {
            if (data.erro) {
                toastr.error(data.message, 'Atenção');
            } else {
                $('#modalRecorrer').modal('toggle');
                toastr.success(data.message, 'Informação', {timeOut: 0});
            }
        });
    }
    $( "[data-name='ver']" ).click(function(e) {
        var elm = $(e.target);
        var aluno_id = {{ aluno.id }};

        $.getJSON("{% url 'professor:get-message' %}?pid=" + elm.data('pid') + '&cid=' + elm.data('curso'), function (data) {
            var items = [];
            $.each(data, function (key, val) {
                /*items.push("<li id='" + key + "'>" + val + "</li>");*/
                var css = 'left';
                if (val.is_professor == true) {
                    var css = 'right';
                }
                items.push('<div class="conversation-item item-' + css + ' clearfix">');
                items.push('    <div class="conversation-user">');
                if (val.is_professor == false) {
                    items.push('        <img src="' + val.img_url + '"/>');
                } else {
                    items.push('        <img src="' + val.img_prof_url + '"/>');
                }
                items.push('    </div>');
                items.push('    <div class="conversation-body">');
                items.push('        <div class="name">');
                if (val.is_professor == false) {
                    items.push('            <a href="' + val.aluno_url + '">' + val.aluno + '</a>');
                } else {
                    items.push('            <a href="#">' + val.professor + '</a>');
                }
                items.push('        </div>');
                items.push('        <div class="time hidden-xs">');
                items.push(val.data);
                items.push('        </div>');
                items.push('        <div id="icone-lido-' + val.mensagem_id + '">');

                if (val.is_professor == false) {
                    if (val.lido == true) {
                        items.push('            <a href="javascript:void(0)"><i data-placement="left" data-toggle="tooltip" title="Professor leu sua mensagem." class="fa fa-eye fa-lg pull-right text-success"></i></a>')
                    } else {
                        items.push('            <a href="javascript:void(0)"><i data-placement="left" data-toggle="tooltip" title="Professor não leu sua mensagem." class="fa fa-eye-slash fa-lg pull-right text-danger"></i></a>')
                    }
                } else {
                    if (val.lido == true) {
                        items.push('            <a href="javascript:void(0)"><i data-placement="left" data-toggle="tooltip" title="Marcada como lidar" class="fa fa-check fa-lg pull-right text-success"></i></a>')
                    } else {
                        items.push('            <a href="javascript:void(0)" onclick="startLoad();Dajaxice.apps.professor.msg_set_lido(Dajax.process, {mid:' + val.mensagem_id + '});"><i data-placement="left" data-toggle="tooltip" title="Clique para marcar como visualizada." class="fa fa-eye fa-lg pull-right"></i></a>')

                    }
                }

                items.push('        </div>');
                items.push('        <div class="text">');
                items.push(val.texto);
                items.push('        </div>');
                items.push('    </div>');
                items.push('</div>');
            });
            var html = items.join( "" );

            $('#msg-inner').html(html);
        });
    });
    // ENVIAR MENSAGEM
    $('#cc-close').on('click', function () {
        $(".cc-panel").addClass("animated bounceOutRight");
        $.unblockUI();
    });
    function clear() {
        $(".cc-panel").removeClass("animated");
        $(".cc-panel").removeClass("zoomOutUp");
        $(".cc-panel").removeClass("bounceInRight");
        $(".cc-panel").removeClass("zoomOutUp");
        $(".cc-panel").removeClass("shake");
    }
    $('#btnEnviar').on('click', function () {
        clear();
        var texto = $('#text-message').val();
        var pid = $('#pid').val();
        if (texto == "") {
            $('#input-pk').notify(
                "Digite a mensagem!",
                {position: "bottom"}
            );
            $(".cc-panel").addClass("animated shake");
        } else {
            $("#text-message").val("");
            $.unblockUI();
            startLoad();
            $(".cc-panel").addClass("animated zoomOutUp");
            Dajaxice.apps.professor.enviar_mensagem_sentenca(Dajax.process, {
                'pid': pid,
                'mensagem': texto,
            });
        }
    })
    $('[data-toggle="send"]').on('click', function (e) {
        clear();
        var elm = $(e.currentTarget);
        $('#pid').val(elm.data('pid'));
        $('.cc-user-img').attr('src', elm.data('image'));
        $('.cc-user-info').html(`<strong>${elm.data('nome')}</strong>`);

        $('body').block({message: null, baseZ: 9980});
        $(".cc-panel").removeClass("animated bounceOutRight");
        $(".cc-panel").addClass("animated bounceInRight");
        $("#cc-close").fadeIn();
        $(".cc-panel").show();
    });
    // CHART MODAL
    $('#chartModal').on('hide.bs.modal', function (event) {
        $('#modalHtml').html('')
    });
    $('#chartModal').on('show.bs.modal', function (event) {
        var pk = $(event.relatedTarget).data('pk');
        var posting = $.post('{% url 'professor:formulario-estatistica-sentenca' %}', {pk: pk} );
        {#$.blockUI({ message: 'aguarde' });#}
        posting.done(function( data ) {
            //$.unblockUI();
            if (data.message) {
                toastr.error(data.message, 'Erro');
            };
            if (!data.html) {
                toastr.error('Não há dados para gerar a estatística.', 'Erro');
                $('#modalHtml').html(
                    '<div class="alert alert-danger">\n' +
                    '<i class="fa fa-times-circle fa-fw fa-lg"></i>\n' +
                    '<strong>Opss!</strong> Não há dados para gerar a estatística.' +
                    '</div>'
                );
            } else {
                $('#modalHtml').html(data.html);
                $('#modalBody').slimScroll({
                    start: 'top',
                    height: '400px'
                });
            }
        });
    });
    $(function () {
      $('[data-toggle="popover"]').popover()
    })
</script>
{% endblock %}
